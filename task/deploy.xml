<project>
	<property name="deploy.rsync.options" value="avzcuC" />
	
	<target name="deploy-list" description="list files that would be deployed">
		<phingcall target="deploy">
			<property name="deploy.rsync.options" value="${deploy.rsync.options}n" />
		</phingcall>
	</target>
	
	<target name="deploy-ftp" hidden="true">
		<property name="ftp.port" value="${deploy.${environment}.ftp.port}" />
		<property name="ftp.dir" value="${deploy.${environment}.ftp.dir}" />
		<property name="ftp.host" value="${deploy.${environment}.ftp.host}" />
		<property name="ftp.user" value="${deploy.${environment}.ftp.user}" />
		<property name="ftp.pass" value="${deploy.${environment}.ftp.pass}" />
		<echo msg="FTP Deploy" />
		<echo msg="----------" />
		<echo msg="From:    ./" />
		<echo msg="To:      ftp://${ftp.user}:****@${ftp.host}:${ftp.port}/${ftp.dir}" />
		<ftpdeploy
			host="${ftp.host}" port="${ftp.port}"
			username="${ftp.user}" password="${ftp.pass}"
			dir="${ftp.dir}"
			level="verbose">
			<fileset refid="deploy.ftp.fileset" />
		</ftpdeploy>
	</target>
	
	<target name="deploy-rsync" hidden="true">
		<fail unless="deploy.rsync.options" message="No rsync options defined" />
		<property name="sync.target" value="${deploy.${environment}.rsync.target}" />
		<property name="sync.source" value="${deploy.${environment}.rsync.source}" />
		<property name="sync.extra" value="${deploy.${environment}.rsync.extra}" />
		<!-- confirm when not in list mode -->
		<if>
			<not><contains string="${deploy.rsync.options}" substring="n" /></not>
			<then>
				<fail unless="sync.target" message="No rsync target specified" />
				<echo msg="RSync Deploy" />
				<echo msg="------------" />
				<echo msg="From:   ${sync.source}" />
				<echo msg="To:     ${sync.target}" />
			</then>
		</if>
		<property name="sync.command" value="rsync -${deploy.rsync.options} --progress ${sync.extra} ${deploy.rsync.extra} ${sync.source} -e ssh ${sync.target}" />
		<exec
			escape="false"
			checkreturn="true"
			passthru="true"
			command="${sync.command}"
		/>
	</target>
	
	<target name="deploy" description="deploy everything to live server">
		<phingcall target="${deploy.depends}" />
		<property name="deploy.method" value="rsync" />
		<property name="environment" value="${deploy.default-environment}" />
		<fail unless="deploy.${environment}.${deploy.method}.source" msg="undefined deployment target environment, deploy.${environment}.${deploy.method}.source" />
		<phingcall target="config">
			<property name="environment" value="${environment}" />
		</phingcall>
		<phingcall target="deploy-${deploy.method}" />
		<phingcall target="config">
			<property name="environment" value="local" override="true" />
		</phingcall>
	</target>
</project>